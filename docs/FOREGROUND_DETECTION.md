# 前景检测参数调试指南

## 问题背景

当前系统默认使用**简单 Alpha 融合**，会将广告直接叠加到所有像素上，包括运动员身上。

为了让广告"规避"运动员，我们添加了**基于运动检测的前景分离**功能。

---

## 技术原理

### 帧差法运动检测 (Frame Differencing)

```
当前帧 - 前一帧 = 运动区域
```

**核心思路**：
- 静止的背景（广告牌）→ 差值为 0 → 可以贴广告
- 运动的前景（运动员）→ 差值大 → 不贴广告

**算法流程**：
```
1. 转灰度图
2. 计算帧间差异 (cv.absdiff)
3. 阈值化 → 二值遮罩
4. 形态学处理 → 填补空洞
5. 高斯模糊 → 平滑边缘
6. 应用遮罩渲染
```

---

## 可调参数说明

### 1. 启用前景检测
```
默认值: true (勾选)
```

**作用**：开关运动检测功能

**效果对比**：
- ✅ 开启：广告会尝试规避运动的物体
- ❌ 关闭：简单叠加，广告覆盖所有区域（原始行为）

**建议**：先开启测试效果

---

### 2. 运动检测阈值 (motionThreshold)
```
范围: 5 - 100
默认值: 25
```

**作用**：判断像素是否"运动"的敏感度

**原理**：
```typescript
if (|当前像素 - 前一帧像素| > 阈值) {
  // 标记为运动（前景）
} else {
  // 标记为静止（背景）
}
```

**调整建议**：
- **值太小 (5-15)**：
  - 优点：非常敏感，轻微运动都能检测
  - 缺点：可能误判噪声为运动，广告闪烁
  - 适用：运动员移动缓慢

- **值适中 (20-35)** ⭐ 推荐：
  - 平衡性能，适合大多数场景

- **值太大 (50-100)**：
  - 优点：只检测明显的运动
  - 缺点：可能漏掉缓慢移动的物体
  - 适用：快速移动的运动员

**实验方法**：
1. 标记广告牌区域
2. 播放视频
3. 观察运动员经过时：
   - 广告是否消失/半透明？→ 阈值合适
   - 广告依然覆盖运动员？→ 阈值太大，调小
   - 广告在空白处闪烁？→ 阈值太小，调大

---

### 3. 膨胀核大小 (dilateSize)
```
范围: 0 - 15
默认值: 5
```

**作用**：扩大运动区域的遮罩，填补空洞

**原理** (形态学膨胀)：
```
运动区域 + 膨胀 → 更大的连续区域
```

**视觉效果**：
```
原始遮罩:        膨胀后:
  ● ●            ●●●●●
 ●   ●     →     ●●●●●
  ● ●            ●●●●●
```

**调整建议**：
- **0**：不膨胀，遮罩可能有很多小孔
- **3-7** ⭐ 推荐：填补小孔，边缘连续
- **10+**：过度膨胀，运动员周围过大区域不贴广告

**适用场景**：
- 运动员身上有静止的部分（如球衣号码）→ 增大膨胀
- 遮罩太激进，广告消失太多 → 减小膨胀

---

### 4. 模糊核大小 (blurSize)
```
范围: 0 - 15 (奇数)
默认值: 5
```

**作用**：平滑遮罩边缘，使广告淡入淡出更自然

**原理** (高斯模糊)：
```
硬边缘遮罩:    模糊后:
█████ 0        ▓▓▒▒░ 0
█████ 0   →    ▓▓▒▒░ 0
█████ 0        ▓▓▒▒░ 0
```

**调整建议**：
- **0**：没有模糊，边缘锐利（可能看到方块感）
- **3-7** ⭐ 推荐：平滑过渡，自然融合
- **9+**：过度模糊，广告边缘太软

**视觉效果**：
- 小值：广告边缘清晰，但可能有"硬切"感
- 大值：广告淡入淡出，但边缘可能太模糊

---

## 调试流程示例

### 场景 1: 快速移动的运动员

**现象**：运动员快速跑过，广告依然覆盖在身上

**调试步骤**：
1. ✅ 勾选"启用前景检测"
2. 调低运动阈值：`25 → 15`
3. 增加膨胀：`5 → 8`
4. 观察效果

**预期结果**：运动员经过时，广告区域变透明或消失

---

### 场景 2: 慢动作或静止的运动员

**现象**：运动员站在广告牌前不动，系统无法检测

**原因**：帧差法只能检测**运动**，静止物体无法区分

**解决方案**（当前版本无法完美解决）：
- 方案 1：要求标记时避开运动员
- 方案 2（未来）：使用深度学习语义分割（如 BodyPix）

---

### 场景 3: 广告闪烁严重

**现象**：广告不断闪烁，即使没有运动员

**可能原因**：
- 阈值太低，噪声被误判为运动
- 视频本身有噪声或压缩伪影

**调试步骤**：
1. 提高运动阈值：`25 → 40`
2. 增加模糊：`5 → 9`
3. 减小膨胀：`5 → 3`

---

## 技术限制

### 当前方案（帧差法）的局限性

❌ **无法处理的情况**：
1. **静止的遮挡物**：运动员站着不动时，无法区分
2. **相似颜色**：运动员衣服颜色接近背景
3. **摄像机移动**：整个画面都在动，帧差法失效
4. **光照变化**：阴影、闪光会被误判为运动

✅ **适用的情况**：
1. 固定摄像机视角
2. 运动员快速移动
3. 背景（广告牌）相对静止

---

## 更先进的方案（未来方向）

### 1. 背景减法 (Background Subtraction)
使用 OpenCV 的 `BackgroundSubtractorMOG2`：
```typescript
const bgSubtractor = new cv.BackgroundSubtractorMOG2();
bgSubtractor.apply(frame, mask);
```

**优点**：比帧差法更稳健
**缺点**：需要学习期，摄像机不能移动

---

### 2. 语义分割 (需要深度学习)
使用 TensorFlow.js + BodyPix 或 MediaPipe：
```typescript
const segmentation = await bodyPix.segmentPerson(frame);
// segmentation.data: 每个像素是否为人体
```

**优点**：精确检测人体，即使静止也能分割
**缺点**：需要 GPU，性能开销大

---

### 3. 深度估计
使用 MiDaS 等深度估计模型：
```typescript
const depth = await depthModel.predict(frame);
// 判断哪些像素在广告牌前方
```

**优点**：真正理解前后关系
**缺点**：计算量极大，需要高端 GPU

---

## 推荐配置

### 配置 1: 平衡模式（默认）
```
运动检测阈值: 25
膨胀核大小: 5
模糊核大小: 5
```
适用于大多数场景

---

### 配置 2: 高敏感模式
```
运动检测阈值: 15
膨胀核大小: 8
模糊核大小: 7
```
适用于：运动员移动缓慢、需要更准确的检测

---

### 配置 3: 稳定模式
```
运动检测阈值: 40
膨胀核大小: 3
模糊核大小: 3
```
适用于：视频噪声大、不希望广告闪烁

---

## 实时调试技巧

1. **先标记干净的区域**：第一帧尽量选择没有运动员的广告牌
2. **边播放边调整**：滑块是实时生效的，可以边看视频边调参数
3. **关注临界点**：运动员刚进入/离开广告区域时的效果
4. **对比开关**：切换"启用前景检测"复选框，对比有无检测的差异

---

## 总结

| 参数 | 作用 | 调大效果 | 调小效果 |
|------|------|----------|----------|
| 运动阈值 | 检测敏感度 | 检测不敏感，漏掉慢动作 | 检测过敏，噪声误判 |
| 膨胀核 | 填补空洞 | 运动区域扩大，广告少 | 遮罩可能有孔，广告穿透 |
| 模糊核 | 边缘平滑 | 边缘太软，过渡区大 | 边缘锐利，可能有硬切感 |

**最佳实践**：从默认值开始，根据实际视频效果微调。
